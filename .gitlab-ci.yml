stages:
  - build
  - tests
  - tag_check
  - deploy

build:
  stage: build
  script: ./ci/build.sh
  tags:
    - kubernetes
  image:
    name: registry-public.cloudferro.com/kaniko-project/executor:v1.9.2-debug
    entrypoint: [ "" ]

pytest:
  stage: tests
  image: python:3.12-slim
  allow_failure: false
  tags:
    - kubernetes
  services:
    - name: opensearchproject/opensearch:2.19.1
      alias: opensearch
      variables:
        cluster.name: stac-cluster
        node.name: os01
        network.host: 0.0.0.0
        transport.host: 0.0.0.0
        discovery.type: single-node
        http.port: 9200
        http.cors.enabled: "true"
        plugins.security.disabled: "true"
        plugins.security.ssl.http.enabled: "false"
        OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx1g"
  before_script:
    - ./ci/before_tests.sh
  script:
    - ./ci/pytest.sh
  variables:
    ES_HOST: opensearch
    ES_PORT: "9200"
    ES_USE_SSL: "false"
    ES_VERIFY_CERTS: "false"
    BACKEND: opensearch
    ES_USER: admin
    ES_PASS: admin
  when: on_success

tag_check:
  stage: tag_check
  script: ./ci/tag_image.sh
  tags:
    - kubernetes
  image:
    name: registry-public.cloudferro.com/kaniko-project/executor:v1.9.2-debug
    entrypoint: [""]
  only:
    - tags

.deploy_template: &deploy_configuration
  stage: deploy
  image: registry.cloudferro.com/utils/docker_cache:alpine-latest
  when: manual
  allow_failure: false
  tags:
    - kubernetes

deploy-staging-cyrus:
  <<: *deploy_configuration
  variables:
    ARGOCD_APP_NAME: "cyrus-staging-ingestion-engine-subscriptions"
  script: ./ci/deploy.sh staging-cyrus

deploy-production-creo:
  <<: *deploy_configuration
  only:
    - tags
  variables:
    ARGOCD_APP_NAME: "waw3-2-general-01-prod-catalogue-subscriptions"
  script:
    - ./ci/deploy.sh production-waw3-2-general-01
