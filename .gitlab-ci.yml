stages:
  - build
#  - tests
#  - tag_check
  - deploy

build:
  stage: build
  script: ./ci/build.sh
  tags:
    - kubernetes
  image:
    name: registry-public.cloudferro.com/kaniko-project/executor:v1.9.2-debug
    entrypoint: [ "" ]

#pytest:
#  stage: tests
#  image: python:3.13-slim
#  allow_failure: false
#  tags:
#    - kubernetes
#  services:
#    - name: opensearchproject/opensearch:2.11.1
#      alias: opensearch
#      variables:
#        cluster.name: "stac-cluster"
#        node.name: "os01"
#        discovery.type: "single-node"
#        plugins.security.disabled: "true"
#        action.destructive_requires_name: "false"
#        OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx1g"
#  before_script:
#    - ./ci/before_tests.sh
#  script:
#    - ./ci/pytest.sh
#  variables:
#    ENVIRONMENT: "testing"
#    ES_HOST: "opensearch"
#    ES_PORT: "9200"
#    ES_USE_SSL: "false"
#    ES_VERIFY_CERTS: "false"
#    BACKEND: "opensearch"
#    DATABASE_REFRESH: "true"
#    ENABLE_DATETIME_INDEX_FILTERING: "true"
#
#  when: on_success

#tag_check:
#  stage: tag_check
#  script: ./ci/tag_image.sh
#  tags:
#    - kubernetes
#  image:
#    name: registry-public.cloudferro.com/kaniko-project/executor:v1.9.2-debug
#    entrypoint: [""]
#  only:
#    - tags

.deploy_template: &deploy_configuration
  stage: deploy
  image: registry.cloudferro.com/utils/docker_cache:alpine-latest
  when: manual
  allow_failure: false
  tags:
    - kubernetes

deploy-staging-cyrus:
  <<: *deploy_configuration
  variables:
    ARGOCD_APP_NAME: "stac-fastapi-os"
  script: ./ci/deploy.sh staging/cyrus

deploy-production-creo:
  <<: *deploy_configuration
#  only:
#    - tags
  variables:
    ARGOCD_APP_NAME: "stac-fastapi-os"
  script:
    - ./ci/deploy.sh prod/waw3-2-general-01
